name: Winget Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.123)'
        required: true
        type: string

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ inputs.version }}"
          $tag = "v$version"
          gh release download $tag --pattern "checksums.txt" --dir artifacts

      - name: Install wingetcreate
        run: |
          iwr https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Update and submit manifest
        run: |
          $version = "${{ inputs.version }}"
          $baseUrl = "https://github.com/open-cli-collective/salesforce-cli/releases/download/v$version"

          ./wingetcreate.exe update OpenCLICollective.salesforce-cli `
            --version $version `
            --urls "$baseUrl/sfdc_${version}_windows_amd64.zip|x64" "$baseUrl/sfdc_${version}_windows_arm64.zip|arm64" `
            --submit `
            --token ${{ secrets.WINGET_GITHUB_TOKEN }}
